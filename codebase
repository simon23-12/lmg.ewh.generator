import streamlit as st
from groq import Groq
import os

# --- Ladefunktion f√ºr deine Markdown-Beispiele ---
def load_example(thema):
    # Sucht die passende .md Datei im Ordner 'vorlagen'
    file_path = os.path.join("vorlagen", f"{thema}.md")
    if os.path.exists(file_path):
        with open(file_path, "r", encoding="utf-8") as f:
            return f.read()
    return "Fehler: Beispiel-Vorlage nicht gefunden."

# --- Streamlit App Logik ---
st.title("üéì NRW EH-Generator (Kostenlose Version)")

api_key = st.sidebar.text_input("Groq API Key (kostenlos von console.groq.com)", type="password")
st.sidebar.markdown("---")

# W√§hle das passende Beispiel (zur besseren F√ºhrung der KI)
beispiel_thema = st.sidebar.selectbox(
    "1. W√§hle das beste Beispiel-Thema", 
    ["Q1_American_Dream", "Q1_Nigeria", "Q1_Gender_Identity", "Q1_Monarchy"] 
)
st.sidebar.markdown("---")

# Lade den Text vom Lehrer
text_input = st.text_area("2. Klausurtext hier einf√ºgen (vom Lehrer):", height=300)

if st.button("3. Erwartungshorizont erstellen"):
    if not api_key or not text_input:
        st.error("Bitte gib zuerst den API Key ein und f√ºge den Klausurtext hinzu.")
    else:
        client = Groq(api_key=api_key)
        
        # Das LLM liest zuerst dein Muster-EH und dann den neuen Text.
        muster_eh = load_example(beispiel_thema)
        
        system_prompt = f"""
        Du bist ein Fachleiter f√ºr Englisch in Nordrhein-Westfalen (NRW). 
        Deine Hauptaufgabe ist es, f√ºr den vom User bereitgestellten Klausurtext einen detaillierten Erwartungshorizont (EH) zu erstellen.

        **BEFOLGE STRENG DIE VORGABEN DES FOLGENDEN MUSTERBEISPIELS:**
        Das Musterbeispiel unten stammt aus der gleichen Jahrgangsstufe (Q1) und zeigt dir das exakte Format (AFB I, II, III) und die Punkteverteilung.
        
        ### MUSTERBEISPIEL ANFANG ###
        {muster_eh} 
        ### MUSTERBEISPIEL ENDE ###
        
        Erstelle nun f√ºr den neuen Input-Text einen EH im exakt gleichen Format und Stil.
        """

        with st.spinner(f'KI analysiert den Text und orientiert sich an {beispiel_thema}.md...'):
            try:
                chat_completion = client.chat.completions.create(
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": text_input}
                    ],
                    model="llama3-70b-8192", # Ein sehr starkes, kostenloses Modell von Groq
                    temperature=0.5,
                )
                st.subheader("‚úÖ Generierter Erwartungshorizont")
                st.markdown(chat_completion.choices[0].message.content)
            except Exception as e:
                st.error(f"Fehler bei der Groq API: {e}")
