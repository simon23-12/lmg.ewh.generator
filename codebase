import streamlit as st
from groq import Groq
import os

# --- 1. KONFIGURATION UND UTILITY FUNKTIONEN ---

# Wortzahl-Limits basierend auf den NRW-Vorgaben
WORD_LIMITS = {
    "GK (Lesen/Schreiben, Q-Phase)": 800,
    "LK (Lesen/Schreiben, Q-Phase)": 1000,
    "Mediation/Sprachmittlung": 650,
    "EF/GK (Allgemein)": 600,
    "LK Q-Phase (Allgemein)": 800
}

def load_example(thema):
    """L√§dt die passende .md Vorlage aus dem 'vorlagen' Ordner."""
    file_path = os.path.join("vorlagen", f"{thema}.md")
    if os.path.exists(file_path):
        with open(file_path, "r", encoding="utf-8") as f:
            return f.read()
    return "Fehler: Beispiel-Vorlage nicht gefunden."

def count_words(text):
    """Z√§hlt die W√∂rter im Eingabetext."""
    # Split auf Leerzeichen und filtert leere Strings heraus
    return len([word for word in text.split() if word])

# --- 2. STREAMLIT APP LAYOUT ---

st.set_page_config(page_title="NRW EH-Generator", page_icon="üéì")
st.title("üéì NRW Erwartungshorizont-Generator (Kostenlos)")
st.caption("Powered by Llama 3 & Groq API")

# Sidebar f√ºr Einstellungen
st.sidebar.header("‚öôÔ∏è Konfiguration")
api_key = st.sidebar.text_input("Groq API Key (kostenlos von console.groq.com)", type="password")
st.sidebar.markdown("---")

# Selection 1: Course Type (GK/LK/EF)
course_type = st.sidebar.selectbox(
    "1. Kursniveau:",
    ["GK/EF (Grundkurs)", "LK (Leistungskurs)"]
)

# Selection 2: Task Type (used for Word Count Validation)
task_type = st.sidebar.selectbox(
    "2. Aufgabentyp (zur Wortzahl-Pr√ºfung):",
    list(WORD_LIMITS.keys())
)
st.sidebar.markdown("---")

# Selection 3: LLM Template (to improve EH quality)
example_theme = st.sidebar.selectbox(
    "3. W√§hle das am besten passende Musterbeispiel (f√ºr die KI-F√ºhrung):",
    ["Q1_American_Dream", "Q1_Nigeria", "Q1_Gender_Identity", "Q1_Monarchy"] 
)
st.sidebar.markdown("---")

# Main Content Area
st.subheader("üìù Klausurtext Eingabe")
st.markdown("Bitte **kopiere den vollst√§ndigen Klausurtext** (Source Text & Aufgaben) hier ein.")
text_input = st.text_area("Klausurtext (Copy/Paste):", height=400)

# --- 3. WORTZAHL-VALIDIERUNG ---
word_count = count_words(text_input)
# W√§hlt das Limit basierend auf der Auswahl aus, Standard ist 800
limit = WORD_LIMITS.get(task_type, 800) 

# Anzeige der Wortzahl
st.info(f"Aktuelle Wortzahl: **{word_count}** W√∂rter. Das Limit f√ºr '{task_type}' ist **{limit}** W√∂rter.")

# Warnung bei √úberschreitung
if word_count > limit:
    st.warning(f"‚ö†Ô∏è ACHTUNG: Die Wortzahl ({word_count}) √ºberschreitet die empfohlene Obergrenze ({limit}) f√ºr **{task_type}**.")
elif word_count < 200 and word_count > 0:
    st.warning("‚ö†Ô∏è WARNUNG: Der Text ist sehr kurz. Bitte pr√ºfen Sie, ob Sie den vollst√§ndigen Source Text und die Aufgabenstellung eingef√ºgt haben.")


# --- 4. EXECUTION ---
if st.button("üöÄ Erwartungshorizont erstellen"):
    if not api_key:
        st.error("Bitte gib den Groq API Key in der Seitenleiste ein.")
    elif not text_input:
        st.error("Bitte f√ºge den Klausurtext in das Eingabefeld ein.")
    else:
        # LLM Call Logic
        client = Groq(api_key=api_key)
        
        # Lade das relevante Muster aus dem 'vorlagen' Ordner
        muster_eh = load_example(example_theme)
        
        # System Prompt: Anpassung an das ausgew√§hlte Kursniveau
        system_prompt = f"""
        Du bist ein Fachleiter f√ºr Englisch in Nordrhein-Westfalen (NRW) f√ºr das Kursniveau {course_type}. 
        Deine Hauptaufgabe ist es, f√ºr den vom User bereitgestellten Klausurtext einen detaillierten Erwartungshorizont (EH) zu erstellen.
        
        **BEFOLGE STRENG DIE VORGABEN DES FOLGENDEN MUSTERBEISPIELS:**
        Das Musterbeispiel unten zeigt dir das exakte Format (AFB I, II, III) und die Punkteverteilung.
        
        ### MUSTERBEISPIEL ANFANG (Formatvorlage: {example_theme}) ###
        {muster_eh} 
        ### MUSTERBEISPIEL ENDE ###
        
        Erstelle nun f√ºr den neuen Input-Text (Wortzahl: {word_count}) einen EH im exakt gleichen Format und Stil.
        """

        with st.spinner(f'KI analysiert den Text und orientiert sich an {example_theme}.md...'):
            try:
                chat_completion = client.chat.completions.create(
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": text_input}
                    ],
                    model="llama3-70b-8192", 
                    temperature=0.5,
                )
                st.subheader("‚úÖ Generierter Erwartungshorizont")
                st.markdown(chat_completion.choices[0].message.content)
            except Exception as e:
                st.error(f"Fehler bei der Groq API: {e}")
